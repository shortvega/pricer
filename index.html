<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monte Carlo Barrier Options Pricer</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Courier New', monospace; background: #0d1117; color: #c9d1d9; padding: 20px; line-height: 1.5; }
.container { max-width: 1200px; margin: 0 auto; }
h1 { color: #58a6ff; margin-bottom: 20px; font-size: 24px; }
.grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
@media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
.panel { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 20px; margin-bottom: 20px; }
.panel-title { color: #58a6ff; font-size: 14px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
label { display: block; color: #8b949e; font-size: 12px; margin: 12px 0 4px; }
input, select { width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; border-radius: 4px; font-family: inherit; font-size: 14px; }
input:focus, select:focus { outline: none; border-color: #58a6ff; }
.row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.btn-calc { width: 100%; padding: 14px; background: #238636; border: none; color: #fff; font-size: 14px; font-weight: bold; cursor: pointer; border-radius: 6px; margin-top: 20px; font-family: inherit; }
.btn-calc:hover { background: #2ea043; }
.btn-calc:disabled { background: #21262d; color: #484f58; cursor: not-allowed; }
.results-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.results-table th, .results-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #30363d; }
.results-table th { color: #8b949e; font-weight: normal; font-size: 11px; text-transform: uppercase; }
.results-table tr:hover { background: #1f2428; }
.highlight { color: #3fb950; }
.param-display { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; font-size: 12px; }
.param-item { background: #0d1117; padding: 8px 12px; border-radius: 4px; }
.param-label { color: #8b949e; }
.param-value { color: #c9d1d9; font-weight: bold; }
.progress-bar { height: 4px; background: #21262d; border-radius: 2px; margin: 10px 0; overflow: hidden; }
.progress-fill { height: 100%; background: #58a6ff; width: 0%; transition: width 0.3s; }
.status { color: #8b949e; font-size: 12px; margin-top: 10px; }
.greeks-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
.greek-item { background: #0d1117; padding: 12px; border-radius: 4px; text-align: center; }
.greek-label { color: #8b949e; font-size: 11px; text-transform: uppercase; }
.greek-value { color: #c9d1d9; font-size: 16px; margin-top: 4px; }
</style>
</head>
<body>
<div class="container">
<h1>Monte Carlo Barrier Options Pricer</h1>
<div class="grid">
<div>
    <div class="panel">
        <div class="panel-title">Market Parameters</div>
        <label>Spot Price (Sâ‚€)</label>
        <input type="number" id="spot" value="3000">
        <label>Strike Price (K)</label>
        <input type="number" id="strike" value="3750">
        <label>Barrier Level</label>
        <input type="number" id="barrier" value="2500">
        <div class="row">
            <div>
                <label>Volatility (%)</label>
                <input type="number" id="vol" value="58" step="1">
            </div>
            <div>
                <label>Risk-Free Rate (%)</label>
                <input type="number" id="rate" value="3" step="0.1">
            </div>
        </div>
        <label>Days to Maturity</label>
        <input type="number" id="days" value="90">
        <label>Face (Coin Amount)</label>
        <input type="number" id="face" value="1000">
    </div>
    <div class="panel">
        <div class="panel-title">Option Settings</div>
        <div class="row">
            <div>
                <label>Option Type</label>
                <select id="optionType">
                    <option value="put">Put</option>
                    <option value="call">Call</option>
                </select>
            </div>
            <div>
                <label>Barrier Type</label>
                <select id="barrierType">
                    <option value="DO">Down-and-Out (DO)</option>
                    <option value="DI">Down-and-In (DI)</option>
                    <option value="UO">Up-and-Out (UO)</option>
                    <option value="UI">Up-and-In (UI)</option>
                </select>
            </div>
        </div>
    </div>
    <div class="panel">
        <div class="panel-title">Simulation Settings</div>
        <div class="row">
            <div>
                <label>Paths per Epoch</label>
                <input type="number" id="nPaths" value="10000">
            </div>
            <div>
                <label>Epochs</label>
                <input type="number" id="nEpoch" value="50">
            </div>
        </div>
        <label>Timesteps per Day</label>
        <input type="number" id="nTimesteps" value="3">
    </div>
    <button class="btn-calc" id="calcBtn">Run Monte Carlo Simulation</button>
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
    <div class="status" id="status">Ready</div>
</div>
<div>
    <div class="panel">
        <div class="panel-title">Input Summary</div>
        <div class="param-display" id="paramDisplay">
            <div class="param-item"><span class="param-label">Spot:</span> <span class="param-value" id="dispSpot">-</span></div>
            <div class="param-item"><span class="param-label">Strike:</span> <span class="param-value" id="dispStrike">-</span></div>
            <div class="param-item"><span class="param-label">Barrier:</span> <span class="param-value" id="dispBarrier">-</span></div>
            <div class="param-item"><span class="param-label">Type:</span> <span class="param-value" id="dispType">-</span></div>
            <div class="param-item"><span class="param-label">Notional:</span> <span class="param-value" id="dispNotional">-</span></div>
            <div class="param-item"><span class="param-label">Simulations:</span> <span class="param-value" id="dispSims">-</span></div>
        </div>
    </div>
    <div class="panel">
        <div class="panel-title">Pricing Results</div>
        <table class="results-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>USD/Coin</th>
                    <th>Px %</th>
                    <th>Total USD</th>
                    <th>Disc to Van</th>
                    <th>APR</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <tr><td colspan="6" style="color:#8b949e;text-align:center;padding:30px;">Run simulation to see results</td></tr>
            </tbody>
        </table>
    </div>
    <div class="panel">
        <div class="panel-title">Greeks (American Barrier)</div>
        <div class="greeks-grid">
            <div class="greek-item"><div class="greek-label">Delta</div><div class="greek-value" id="gDelta">-</div></div>
            <div class="greek-item"><div class="greek-label">Gamma</div><div class="greek-value" id="gGamma">-</div></div>
            <div class="greek-item"><div class="greek-label">Vega</div><div class="greek-value" id="gVega">-</div></div>
        </div>
    </div>
</div>
</div>
</div>

<script>
// Normal CDF approximation
function normCdf(x) {
    var a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    var sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);
    var t = 1 / (1 + p * x);
    var y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t * Math.exp(-x*x);
    return 0.5 * (1 + sign * y);
}

// Black-Scholes analytical price
function bsPrice(S, K, T, r, sigma, isCall) {
    var d1 = (Math.log(S/K) + (r + 0.5*sigma*sigma)*T) / (sigma*Math.sqrt(T));
    var d2 = d1 - sigma*Math.sqrt(T);
    if (isCall) {
        return S * normCdf(d1) - K * Math.exp(-r*T) * normCdf(d2);
    } else {
        return K * Math.exp(-r*T) * normCdf(-d2) - S * normCdf(-d1);
    }
}

// Box-Muller transform for normal random numbers
function randn() {
    var u1 = Math.random(), u2 = Math.random();
    return Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
}

// Generate GBM paths with antithetic variates
function generatePaths(S0, r, sigma, T, N, nPaths) {
    var dt = T / N;
    var paths = [];
    var halfPaths = nPaths / 2;
    
    for (var p = 0; p < halfPaths; p++) {
        var path1 = [S0], path2 = [S0];
        var s1 = S0, s2 = S0;
        for (var t = 0; t < N; t++) {
            var z = randn();
            var drift = (r - 0.5*sigma*sigma) * dt;
            var diffusion = sigma * Math.sqrt(dt);
            s1 = s1 * Math.exp(drift + diffusion * z);
            s2 = s2 * Math.exp(drift - diffusion * z);
            path1.push(s1);
            path2.push(s2);
        }
        paths.push(path1);
        paths.push(path2);
    }
    return paths;
}

// European vanilla payoff
function europeanVanilla(paths, K, r, T, isCall) {
    var sum = 0;
    for (var i = 0; i < paths.length; i++) {
        var ST = paths[i][paths[i].length - 1];
        var payoff = isCall ? Math.max(ST - K, 0) : Math.max(K - ST, 0);
        sum += payoff;
    }
    return Math.exp(-r * T) * sum / paths.length;
}

// European barrier (only checks terminal price)
function europeanBarrier(paths, K, barrier, barrierType, isCall, r, T) {
    var sum = 0;
    for (var i = 0; i < paths.length; i++) {
        var ST = paths[i][paths[i].length - 1];
        var payoff = isCall ? Math.max(ST - K, 0) : Math.max(K - ST, 0);
        var alive = 1;
        
        if (barrierType === 'UO') alive = ST <= barrier ? 1 : 0;
        else if (barrierType === 'DO') alive = ST >= barrier ? 1 : 0;
        else if (barrierType === 'UI') alive = ST >= barrier ? 1 : 0;
        else if (barrierType === 'DI') alive = ST <= barrier ? 1 : 0;
        
        sum += payoff * alive;
    }
    return Math.exp(-r * T) * sum / paths.length;
}

// American discrete barrier (checks at daily intervals)
function americanDiscreteBarrier(paths, K, barrier, barrierType, isCall, r, T, stepsPerDay) {
    var sum = 0;
    var N = paths[0].length - 1;
    
    for (var i = 0; i < paths.length; i++) {
        var path = paths[i];
        var ST = path[N];
        var payoff = isCall ? Math.max(ST - K, 0) : Math.max(K - ST, 0);
        var alive = 1;
        
        // Check barrier at daily intervals
        for (var t = 0; t <= N; t += stepsPerDay) {
            var S = path[t];
            if (barrierType === 'UO' && S > barrier) { alive = 0; break; }
            if (barrierType === 'DO' && S < barrier) { alive = 0; break; }
            if (barrierType === 'UI' && S > barrier) { alive = 1; break; }
            if (barrierType === 'DI' && S < barrier) { alive = 1; break; }
        }
        
        // For knock-in, need to invert logic
        if (barrierType === 'UI' || barrierType === 'DI') {
            var hit = 0;
            for (var t = 0; t <= N; t += stepsPerDay) {
                var S = path[t];
                if (barrierType === 'UI' && S >= barrier) { hit = 1; break; }
                if (barrierType === 'DI' && S <= barrier) { hit = 1; break; }
            }
            alive = hit;
        }
        
        sum += payoff * alive;
    }
    return Math.exp(-r * T) * sum / paths.length;
}

// American continuous barrier (checks all timesteps)
function americanBarrier(paths, K, barrier, barrierType, isCall, r, T) {
    var sum = 0;
    var N = paths[0].length - 1;
    
    for (var i = 0; i < paths.length; i++) {
        var path = paths[i];
        var ST = path[N];
        var payoff = isCall ? Math.max(ST - K, 0) : Math.max(K - ST, 0);
        var alive = 1;
        
        // Check all timesteps
        if (barrierType === 'UO') {
            for (var t = 0; t <= N; t++) {
                if (path[t] > barrier) { alive = 0; break; }
            }
        } else if (barrierType === 'DO') {
            for (var t = 0; t <= N; t++) {
                if (path[t] < barrier) { alive = 0; break; }
            }
        } else if (barrierType === 'UI') {
            alive = 0;
            for (var t = 0; t <= N; t++) {
                if (path[t] >= barrier) { alive = 1; break; }
            }
        } else if (barrierType === 'DI') {
            alive = 0;
            for (var t = 0; t <= N; t++) {
                if (path[t] <= barrier) { alive = 1; break; }
            }
        }
        
        sum += payoff * alive;
    }
    return Math.exp(-r * T) * sum / paths.length;
}

// Main calculation
function runSimulation() {
    var S0 = parseFloat(document.getElementById('spot').value);
    var K = parseFloat(document.getElementById('strike').value);
    var barrier = parseFloat(document.getElementById('barrier').value);
    var sigma = parseFloat(document.getElementById('vol').value) / 100;
    var r = parseFloat(document.getElementById('rate').value) / 100;
    var days = parseInt(document.getElementById('days').value);
    var face = parseFloat(document.getElementById('face').value);
    var nPaths = parseInt(document.getElementById('nPaths').value);
    var nEpoch = parseInt(document.getElementById('nEpoch').value);
    var stepsPerDay = parseInt(document.getElementById('nTimesteps').value);
    var optionType = document.getElementById('optionType').value;
    var barrierType = document.getElementById('barrierType').value;
    
    var isCall = optionType === 'call';
    var T = days / 365;
    var N = days * stepsPerDay;
    var notional = S0 * face;
    
    // Update display
    document.getElementById('dispSpot').textContent = S0.toLocaleString();
    document.getElementById('dispStrike').textContent = K.toLocaleString();
    document.getElementById('dispBarrier').textContent = barrier.toLocaleString();
    document.getElementById('dispType').textContent = barrierType + ' ' + optionType.toUpperCase();
    document.getElementById('dispNotional').textContent = '$' + notional.toLocaleString();
    document.getElementById('dispSims').textContent = (nPaths * nEpoch).toLocaleString();
    
    // Disable button
    var btn = document.getElementById('calcBtn');
    btn.disabled = true;
    btn.textContent = 'Running...';
    
    var sumVanilla = 0, sumEuroBarrier = 0, sumAmericanDiscrete = 0, sumAmericanBarrier = 0;
    var epoch = 0;
    
    function runEpoch() {
        if (epoch >= nEpoch) {
            // Finished - calculate final prices
            var totalPaths = nPaths * nEpoch;
            var priceVanillaMC = sumVanilla / nEpoch;
            var priceEuroBarrierMC = sumEuroBarrier / nEpoch;
            var priceAmericanDiscreteMC = sumAmericanDiscrete / nEpoch;
            var priceAmericanBarrierMC = sumAmericanBarrier / nEpoch;
            var priceVanillaBS = bsPrice(S0, K, T, r, sigma, isCall);
            
            // Display results
            displayResults(S0, priceVanillaMC, priceVanillaBS, priceEuroBarrierMC, priceAmericanDiscreteMC, priceAmericanBarrierMC, face, days);
            
            // Calculate Greeks
            calculateGreeks(S0, K, barrier, T, r, sigma, isCall, barrierType, nPaths, Math.min(nEpoch, 20), N, stepsPerDay);
            
            btn.disabled = false;
            btn.textContent = 'Run Monte Carlo Simulation';
            document.getElementById('status').textContent = 'Completed: ' + totalPaths.toLocaleString() + ' paths simulated';
            document.getElementById('progress').style.width = '100%';
            return;
        }
        
        // Generate paths and price
        var paths = generatePaths(S0, r, sigma, T, N, nPaths);
        
        sumVanilla += europeanVanilla(paths, K, r, T, isCall);
        sumEuroBarrier += europeanBarrier(paths, K, barrier, barrierType, isCall, r, T);
        sumAmericanDiscrete += americanDiscreteBarrier(paths, K, barrier, barrierType, isCall, r, T, stepsPerDay);
        sumAmericanBarrier += americanBarrier(paths, K, barrier, barrierType, isCall, r, T);
        
        epoch++;
        var pct = (epoch / nEpoch * 100).toFixed(0);
        document.getElementById('progress').style.width = pct + '%';
        document.getElementById('status').textContent = 'Running epoch ' + epoch + ' of ' + nEpoch + '...';
        
        // Use setTimeout to allow UI updates
        setTimeout(runEpoch, 0);
    }
    
    runEpoch();
}

function displayResults(S0, vanillaMC, vanillaBS, euroBarrier, amDiscrete, amBarrier, face, days) {
    var tbody = document.getElementById('resultsBody');
    var rows = [
        ['Vanilla MC', vanillaMC, '-', '-'],
        ['Vanilla BS', vanillaBS, '-', '-'],
        ['European Barrier MC', euroBarrier, vanillaBS, true],
        ['American Discrete', amDiscrete, vanillaBS, true],
        ['American Barrier', amBarrier, vanillaBS, true]
    ];
    
    var html = '';
    for (var i = 0; i < rows.length; i++) {
        var r = rows[i];
        var price = r[1];
        var pxPct = (price / S0 * 100).toFixed(2) + '%';
        var totalUsd = (price * face).toFixed(2);
        var disc = r[2] !== '-' ? (((price / r[2]) - 1) * 100).toFixed(2) + '%' : '-';
        var apr = r[3] ? ((price / S0) * 100 * (365 / days)).toFixed(2) + '%' : '-';
        
        html += '<tr>';
        html += '<td>' + r[0] + '</td>';
        html += '<td>' + price.toFixed(4) + '</td>';
        html += '<td>' + pxPct + '</td>';
        html += '<td>$' + parseFloat(totalUsd).toLocaleString() + '</td>';
        html += '<td>' + disc + '</td>';
        html += '<td>' + apr + '</td>';
        html += '</tr>';
    }
    tbody.innerHTML = html;
}

function calculateGreeks(S0, K, barrier, T, r, sigma, isCall, barrierType, nPaths, nEpoch, N, stepsPerDay) {
    var eps = 0.005;
    var S_up = S0 * (1 + eps);
    var S_down = S0 * (1 - eps);
    var sigma_up = sigma + 0.01;
    
    // Price at different spots
    var price_base = 0, price_up = 0, price_down = 0, price_vega = 0;
    
    for (var e = 0; e < nEpoch; e++) {
        var paths = generatePaths(S0, r, sigma, T, N, nPaths);
        price_base += americanBarrier(paths, K, barrier, barrierType, isCall, r, T);
        
        var pathsUp = generatePaths(S_up, r, sigma, T, N, nPaths);
        price_up += americanBarrier(pathsUp, K, barrier, barrierType, isCall, r, T);
        
        var pathsDown = generatePaths(S_down, r, sigma, T, N, nPaths);
        price_down += americanBarrier(pathsDown, K, barrier, barrierType, isCall, r, T);
        
        var pathsVega = generatePaths(S0, r, sigma_up, T, N, nPaths);
        price_vega += americanBarrier(pathsVega, K, barrier, barrierType, isCall, r, T);
    }
    
    price_base /= nEpoch;
    price_up /= nEpoch;
    price_down /= nEpoch;
    price_vega /= nEpoch;
    
    var delta = (price_up - price_down) / (2 * S0 * eps);
    var gamma = (price_up - 2 * price_base + price_down) / Math.pow(S0 * eps, 2);
    var vega = price_vega - price_base;
    
    document.getElementById('gDelta').textContent = delta.toFixed(4);
    document.getElementById('gGamma').textContent = gamma.toFixed(6);
    document.getElementById('gVega').textContent = vega.toFixed(4);
}

// Attach event listener
document.getElementById('calcBtn').addEventListener('click', runSimulation);
</script>
</body>
</html>
